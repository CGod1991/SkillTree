# Zookeeper 原理

标签：Zookeeper

---

## 简介

- ZooKeeper 的设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用。
- ZooKeeper 将全量数据存储在内存中，以此来实现提高服务器吞吐、减少延迟的目的。
- 组成 ZooKeeper 集群的每台机器都会在内存中维护当前的服务器状态，并且每台机器之间都保持着通信。
- ZooKeeper 的客户端会选择和集群中的任意一台服务器共同来创建一个 TCP 连接，而一旦客户端和 ZooKeeper 集群中的某台服务器断开连接，客户端会自动连接到集群中的其他机器。
- 在 ZooKeeper 中，一个客户端连接指的是客户端和服务器之间的 TCP 长连接。
- 临时节点的生命周期和客户端会话绑定，一旦一个客户端会话失效，那么该客户端所创建的所有临时节点都会被删除。

## ZAB 协议

- 在解决分布式数据一致性方面，ZooKeeper 并没有采用 Paxos 算法，而是采用了 ZAB（ZooKeeper Atomic Broadcast）协议。
- ZAB 协议是为分布式协调服务 ZooKeeper 专门设计的一种支持崩溃回复的原子广播协议。
- ZAB 协议包括两种基本的模式，分别是崩溃恢复和消息广播：
	- 崩溃恢复：当整个服务框架处在启动的过程中，或者是当 Leader 服务器出现网络中断、崩溃退出或重启等异常情况时，ZAB 协议就会进入恢复模式并选举产生新的 Leader 服务器。
	- 消息广播：当集群中已经选举出了新的 Leader 服务器，并且集群中有超过半数的服务器与 Leader 服务器完成了状态同步，那么 ZAB 协议就会退出崩溃恢复模式，进入消息广播模式。

- 当一台同样遵守 ZAB 协议的服务器启动后加入集群时，如果此时集群中已经存在一个 Leader 服务器负责消息广播，那么新加入的服务器就会自动进入数据恢复模式：先与 Leader 服务器进行数据同步，然后参与到消息广播的流程中。
- 消息广播模式是基于具有 FIFO 特性的 TCP 协议来进行网络通信的，因此能够很容易的保证消息广播过程中消息接收与发送的顺序性。
- 在消息广播过程中，Leader 服务器会为每一个 Follower 服务器各自分配一个队列，然后将需要广播的事务依次放入这些队列中，并根据 FIFO 的策略进行消息的发送。

