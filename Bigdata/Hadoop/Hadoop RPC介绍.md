# Hadoop RPC 介绍

标签：Hadoop RPC

---

## 什么是 RPC

RPC（Remote Procedure Call，远程过程调用）是一种常用的分布式网络通信协议，它允许运行在一台计算机上的程序调用另一台计算机上的子程序，并且隐藏了具体的网络通信细节，使得用户无须为网络通信交互进行编程。RPC 使得开发分布式程序更加容易。

RPC 的访问透明性，指的是当用户在一台计算机的程序中调用另一台计算机的子程序时，用户自身不应该感知到该过程涉及到跨机器间的通信，而是感觉像在执行一个本地调用。

## RPC 组成

一个典型的 RPC 架构中主要包含以下几个部分：
- 通信模块：客户端和服务端都存在，可理解成 Socket，在客户端和服务端之间传递请求和响应消息。
- Stub 程序：客户端和服务端都存在，可以理解成代理对象，主要用于保证 RPC 的透明性。
	- 在客户端，Stub 程序表现的就像本地程序一样，但不直接执行本地调用，而是将请求信息通过通信模块发送给服务端；当接收到通信模块返回的服务端响应后，解码对应结果。
	- 在服务端，Stub 程序进行的操作包括：解码请求信息中的参数、调用响应的服务过程、编码响应结果等。

- 调度程序：只存在服务端，主要负责接收来自通信模块的请求信息，并根据其中的标识选择一个 Stub 程序进行处理。
- 客户程序：只存在客户端，是请求的发出者。
- 服务过程：只存在服务端，是请求的处理者。

## RPC 流程

通常情况下，一个 RPC 请求从发送到获取响应结果，具体流程如下：
- 客户程序以本地方式调用系统产生的 Stub 程序。
- 该 Stub 程序将函数调用信息按照通信模块的要求封装成消息包，然后交给通信模块发送到远程服务端。
- 服务端的通信模块接收到此消息后，将其发送给对应的 Stub 程序。
- Stub 程序解析消息包，形成被调过程要求的形式，然后调用对应的函数。
- 服务端执行被调用函数，并将结果返回给 Stub 程序。
- Stub 程序将响应结果封装成消息包，通过通信模块逐级的传递给客户程序。

## Hadoop RPC

Hadoop RPC 是对 RPC 协议的一种简单实现。

### 特点

Hadoop RPC 主要具备以下几个特点：
- 透明性：这是所有 RPC 框架都应该具备的最基本特点，即当用户在一条计算机上调用另一台计算机上的子程序时，用户自身不应该感觉到其间涉及的跨机器间的通信，而是感觉像执行一个本地程序。
- 高性能：Hadoop 的各个系统（如 HDFS、YARN、MR）均采用了 Master/Slave 架构，其中，Master 实际上是一个 RPC Server，它负责处理集群中所有 Slave 发送的服务请求。为了保证 Master 的并发处理能力，Hadoop RPC Server 被设计实现成了一个高性能服务器，能够高效的处理来自多个 Client 的并发 RPC 请求。
- 可控性：由于 JDK 自带的 RPC 框架 RMI（Remote Method Invocation，远程方法调用）重量级过大且用户可控处比较少，因此 Hadoop 实现了自己的 RPC 框架。

### 组成

同其他的 RPC 框架一样，Hadoop RPC 主要分为四部分：
-  序列化层：将结构化数据序列化为字节流，以便于在网络上进行传输或者进行永久存储。在 RPC 框架中，主要用于将用户请求中的参数或者应答转换成字节流，方便进行跨机器传输。在 YARN 中，Hadoop RPC 在该层使用了 Protocol Buffers 实现。
-  函数调用层：定位要调用的函数并执行该函数。Hadoop RPC 采用了 Java 反射机制与动态代理来实现。
-  网络传输层：描述了 Client 和 Server 之间消息传输的方式。Hadoop RPC 采用了基于 TCP/IP 的 Socket 机制实现。
-  服务器端处理框架：描述了客户端和服务器端之间的信息交互方式。Hadoop RPC 采用了基于 Reactor 设计模式的事件驱动 I/O 模型实现。

### 使用

在 Hadoop RPC 中对外提供了两个接口：一个用来构造客户端代理对象（该对象实现了某个协议），用于向服务器发送 RPC 请求，如 getProxy(···) 或 waitForProxy(···) 方法；另外一个用来为某个协议实例构造一个服务器对象，用于处理客户端发送的请求，如 RPC.Builder(Configuration).build() 方法。

一般情况下，使用 Hadoop RPC 可分为以下几个步骤：
- 定义 RPC 协议：RPC 协议实际上就是客户端和服务端之间通信的接口，它定义了服务端对外提供的服务接口。在客户端和服务端都需要有该协议，这样客户端才能像调用本地方法一样调用服务端的方法。
- 实现 RPC 协议：Hadoop RPC 协议通常是一个 Java 接口，用户需要实现该接口，在具体的实现类中定义方法的具体逻辑。该实现类定义在服务端的程序中，以供服务端接收到客户端请求后进行调用。
- 构造并启动 RPC Server：在服务端使用 RPC.Builder 静态类的 build() 方法构造一个 RPC Server，然后调用 Server 的 start() 方法启动该 Server。此时，服务端处于监听状态，等待客户端的请求到达。
- 构造 RPC Client 并发送 RPC 请求：在客户端程序中使用 RPC 的 getProxy() 方法构造客户端代理对象，直接通过代理对象就可以调用服务端的方法。在客户端，当通过代理对象调用本地的 RPC 协议中定义的方法时，Hadoop RPC 框架会自动跟远程服务端进行通信并调用服务端对应的方法。