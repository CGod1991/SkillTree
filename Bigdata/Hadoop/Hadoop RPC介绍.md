# Hadoop RPC 介绍

标签：Hadoop RPC

---

## 什么是 RPC

RPC（Remote Procedure Call，远程过程调用）是一种常用的分布式网络通信协议，它允许运行在一台计算机上的程序调用另一台计算机上的子程序，并且隐藏了具体的网络通信细节，使得用户无须为网络通信交互进行编程。RPC 使得开发分布式程序更加容易。

RPC 的访问透明性，指的是当用户在一台计算机的程序中调用另一台计算机的子程序时，用户自身不应该感知到该过程涉及到跨机器间的通信，而是感觉像在执行一个本地调用。

## RPC 组成

一个典型的 RPC 架构中主要包含以下几个部分：
- 通信模块：客户端和服务端都存在，可理解成 Socket，在客户端和服务端之间传递请求和响应消息。
- Stub 程序：客户端和服务端都存在，可以理解成代理对象，主要用于保证 RPC 的透明性。
	- 在客户端，Stub 程序表现的就像本地程序一样，但不直接执行本地调用，而是将请求信息通过通信模块发送给服务端；当接收到通信模块返回的服务端响应后，解码对应结果。
	- 在服务端，Stub 程序进行的操作包括：解码请求信息中的参数、调用响应的服务过程、编码响应结果等。

- 调度程序：只存在服务端，主要负责接收来自通信模块的请求信息，并根据其中的标识选择一个 Stub 程序进行处理。
- 客户程序：只存在客户端，是请求的发出者。
- 服务过程：只存在服务端，是请求的处理者。

## RPC 流程

通常情况下，一个 RPC 请求从发送到获取响应结果，具体流程如下：
- 客户程序以本地方式调用系统产生的 Stub 程序。
- 该 Stub 程序将函数调用信息按照通信模块的要求封装成消息包，然后交给通信模块发送到远程服务端。
- 服务端的通信模块接收到此消息后，将其发送给对应的 Stub 程序。
- Stub 程序解析消息包，形成被调过程要求的形式，然后调用对应的函数。
- 服务端执行被调用函数，并将结果返回给 Stub 程序。
- Stub 程序将响应结果封装成消息包，通过通信模块逐级的传递给客户程序。

## Hadoop RPC

同其他的 RPC 框架一样，Hadoop RPC 主要分为四部分：
-  序列化层：将结构化数据序列化为字节流，以便于在网络上进行传输或者进行永久存储。在 RPC 框架中，主要用于将用户请求中的参数或者应答转换成字节流，方便进行跨机器传输。在 YARN 中，Hadoop RPC 在该层使用了 Protocol Buffers 实现。
-  函数调用层：定位要调用的函数并执行该函数。Hadoop RPC 采用了 Java 反射机制与动态代理来实现。
-  网络传输层：描述了 Client 和 Server 之间消息传输的方式。Hadoop RPC 采用了基于 TCP/IP 的 Socket 机制实现。
-  服务器端处理框架：描述了客户端和服务器端之间的信息交互方式。Hadoop RPC 采用了基于 Reactor 设计模式的事件驱动 I/O 模型实现。