# Paxos 算法

标签：Paxos 分布式一致性

---

## 简介

Paxos 算法解决的问题是：一个分布式系统如何就某个值（或协议）达成一致。

## 分布式系统

- 副本是分布式系统最常见的概念之一，指的是分布式系统对数据和服务提供的一种冗余方式。
- 在常见的分布式系统中，为了对外提供高可用的服务，通常会对数据和服务进行副本处理。
- 数据副本指的是在不同的节点上持久化同一份数据，当某一个节点上存储的数据丢失时，就可以从副本上读取到该数据，这是解决分布式系统中数据丢失问题最有效的手段。
- 服务副本指的是多个节点提供同样的服务，每个节点都有能力接受来自外部的请求并进行相应的处理。

## 一致性协议

- 协调者负责调度参与者的行为，并最终决定这些参与者是否要把事务真正进行提交。
- 简单的说，二阶段提交将一个事务的处理过程分为了投票和执行两个阶段，其核心是对每个事务都采取先尝试后提交的处理方式。
- 三阶段提交相比于二阶段提交的改进，主要是将二阶段提交中的第一阶段（也就是请求事务提交阶段）分为两个阶段，形成了由 CanCommit、PreCommit 和 DoCommit 三个阶段组成的事务处理协议。
- 对于三阶段提交协议，当进入第三阶段后，如果出现异常情况导致参与者无法收到来自协调者的 DoCommit 或 abort 请求，参与者都会在等待超时之后，继续进行事务提交。

## Paxos 原理

- 从整体上来说，Paxos 算法的目标就是要保证有一个提案被选定，当提案被选定后，进程最终也能获取到被选定的提案。
- Paxos 算法中主要有三个角色：Proposer（提案人）、Acceptor（接受者）和 Learner。
- Paxos 算法的大体执行过程如下：
	- Proposer 选择一个提案编号 M，然后向 Acceptor 的某个超过半数的子集成员发送编号为 M 的 Prepare 请求。
	- 如果一个 Acceptor 收到编号为 M 的 Prepare 请求，并且 M 大于该 Acceptor 已经响应的所有 Prepare 请求的编号，那么它会把它已经批准过的编号最大的提案作为响应反馈给 Proposer，同时该 Acceptor 承诺不会批准任何编号小于 M 的提案。
	- 如果 Proposer 收到了来自半数以上的 Acceptor 对其发出的编号为 M 的 Prepare 请求的响应，那么它会发送一个针对 <M, V> 提案的 Accept 请求给 Acceptor。
	- 如果 Acceptor 收到这个 <M, V> 提案的 Accept 请求，只要该 Acceptor 尚未对编号大于 M 的 Prepare 请求作出响应，那么它就可以通过该提案。

## Chubby

- Chubby 是 Google 实现的一个分布式锁服务，在 GFS 和 BigTable 分布式系统中都使用 Chubby 来解决分布式协作、元数据存储和 Master 选举等一系列与分布式锁服务相关的问题。
- Chubby 的底层一致性实现就是以 Paxos 算法为基础的。
- Zookeeper 就是 Chubby 的开源实现。
- Chubby 客户端通过向记录有 Chubby 服务器列表的 DNS 来请求获取所有的 Chubby 服务器列表，然后依次向获取到的服务器发起请求，询问该服务器是否是 Chubby 的 Master。如果当前询问的服务器不是 Master，则该服务器会把 Master 的服务器信息反馈给客户端，从而使得客户端可以快速的定位到 Master。
- 如果 Chubby 集群中的 Master 服务器崩溃了，那么集群中的其他服务器会在 Master 的租期到期后，重新进行新一轮的 Master 选举。
- 在 Chubby 中，任意一个数据节点都可以充当一个读写锁来使用：
	- 单个客户端以排他模式（写）持有这个锁，或者：
	- 任意数目的客户端以共享模式（读）持有这个锁。

- Chubby 的客户端和服务端通过创建一个 TCP 连接来进行所有的网络通信操作，这一连接被称为会话。
- 每个会话是有生命周期的，存在一个超时时间，在这个超时时间内，Chubby 客户端和服务端之间通过心跳检测来保持会话的活性，以使会话周期得到延续，这个过程被称为 KeepAlive。
- 除了为客户端会话续租外，Master 还将通过 KeepAlive 响应来传递 Chubby 事件通知和缓存过期通知给客户端。
- 在 Chubby 中，Paxos 算法的作用就在于保证集群内各个副本节点的日志能够保持一致。