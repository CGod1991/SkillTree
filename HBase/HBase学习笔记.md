# HBase 学习笔记

标签：HBase

---

## 概述

- HBase 中扩展和负载均衡的基本单元是 region，region 本质上是以行键排序的连续的存储区间。
- 当用户向表中插入数据时，系统会检查这个 region 的大小，确保不会超过其配置的最大值。如果发现 region 的大小超过了限制，那么系统会在 region 中间的那个行键处将该 region 拆分成两个大致相等的子 region。
- 每一个 region 只能由一台 region 服务器（region server）加载，每台 region 服务器可以加载多个 region。
- HBase 支持单行事务，基于这个特性实现了对单个行键下存储的数据的原子读-修改-写序列。
- 协处理器：服务端框架，可以在服务器的地址空间中执行来自客户端的代码。
- HFile：HBase 中的数据存储文件，其中存储的是经过排序的键值映射结构。HFile 内部由连续的块组成，块的索引信息存储在文件的尾部。当把 HFile 文件打开并加载到内存中时，索引信息会优先加载到内存中。块的大小可配置，默认为 64KB。
- WAL（write-ahead log，预写日志）：记录了每次更新的数据，HBase 先将要更新的数据成功写到 WAL 中后，才将这些数据写入内存中的 memstore 中。
- 当内存中保存的写入数据达到给定的最大值时，HBase 会将这些数据以 HFile 文件的格式保存到存储层。
- HFile 中的内容不能被修改，如果想要删除 HBase 中的某行，实际的做法是给该行做个删除标记，表明该行已经被删除了。客户端在读取数据的时候会忽略有删除标记的数据。
- 随着数据的不断写入，HFile 的数量会越来越多，HBase 内部会通过合并将多个文件合并成一个大文件。主要的合并方式有以下两种：
	- minor 合并：将多个小文件重写为数量较少的大文件，实际上是多路归并的过程。
	- major 合并：将一个 region 中的一个列族的多个 HFile 重写为一个新的 HFile。同时还会扫描所有的键值对，顺序重写全部的数据，在重写的过程中会忽略做了删除标记的数据。

- HBase 中有三个主要的组件：客户端库、主服务器和 region 服务器。
	- 主服务器：负责利用 Zookeeper 为 region 服务器分配 region。主服务器管理跨 region 服务器的 region 的负载均衡，将繁忙服务器中的 region 迁移到负载较轻的服务器中。每台 region 服务器都会在 Zookeeper 中注册一个临时节点，主服务器就利用这些临时节点来发现可用的 region 服务器，同时跟踪机器故障和网络分区。
	- region 服务器：负责为它服务的 region 提供读写请求，也提供了拆分超过配置大小的 region 的接口。客户端直接与 region 服务器通信，处理所有的数据操作。

- 在 Zookeeper 中，每个临时节点都属于一个会话，这个会话是客户端（在这里就是 HBase 集群）连接上 Zookeeper 服务器后自动生成的。每个会话在 Zookeeper 中都有一个唯一的 id，并且客户端会以此 id 不断的向 Zookeeper 服务器发送心跳，一旦客户端进程死掉，Zookeeper 会认为该会话超时，并将该会话下的所有临时节点都删除。
- 主服务器不是实际数据存储或者检索路径的组成部分，它仅提供了负载均衡和集群管理，不为 region 服务器或客户端提供任何的数据服务，因此是轻量级服务器。
- 同时，主服务器提供了元数据的管理操作，比如建表和创建列族。
- HBase 表中的每行数据只由一台服务器所服务，因此 HBase 具有强一致性，使用多版本可以避免因并发解耦过程引起的编辑冲突，而且可以保留这一行的历史变化。